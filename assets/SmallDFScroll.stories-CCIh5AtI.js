var O=Object.defineProperty;var T=(e,t,s)=>t in e?O(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var h=(e,t,s)=>T(e,typeof t!="symbol"?t+"":t,s);import{j as C}from"./jsx-runtime-DiklIkkE.js";import{r as F}from"./index-DRjF_FHU.js";import{g as j,a as H}from"./gridUtils-ttv7OPgW.js";import{l as g}from"./lodash-CGIzQN7T.js";import"./HistogramCell-WXbqT_Ov.js";import"./index-Bx0Ph3cE.js";import"./ChartCell-CdGzSEf4.js";import"./tiny-invariant-CopsF_GD.js";import"./main.esm-CraDeAap.js";const m=e=>`${e.sourceName}-${e.start}-${e.end}-${e.sort}-${e.sort_direction}`,x=e=>`${e.sourceName}-${e.sort}-${e.sort_direction}`,p=(e,t,s,n)=>{if(e.length==0)return[[s],[n]];const[r,o]=s,[i,a]=e[0];if(o<i)return[[s,...e],[n,...t]];const[c,l]=[[],[]];for(var u=0;u<e.length;u++){const[f,q]=[e[u],t[u]];if(d(f,s)){const[K,P]=z([f,q],[s,n]),G=c.concat(e.slice(u+1)),N=l.concat(t.slice(u+1));return p(G,N,K,P)}c.push(f),l.push(q),u<e.length-1&&D(s,f,e[u+1])&&(c.push(s),l.push(n))}const[L,y]=e[e.length-1];return y<r&&(c.push(s),l.push(n)),[c,l]},z=(e,t)=>{const[s,n]=e,[r,o]=t;if(S(r,s))return z(t,e);const[i,a]=s,[c,l]=r;if(i<c&&l<a)return e;if(a===c){const y=n.concat(o);return[[i,l],y]}const u=c-a,L=n.slice(0,u).concat(o);return[[i,l],L]},D=(e,t,s)=>{if(S(s,t))return D(e,s,t);const[n,r]=e,o=t[1],i=s[0];return o<n&&r<i},S=(e,t)=>{const[s,n]=e,[r,o]=t;return s<r?!0:s==r&&n<o},E=(e,t)=>{const[s,n]=e,[r,o]=t;return s<=r&&o<=n},d=(e,t)=>{if(S(t,e))return d(t,e);const[s,n]=e,[r,o]=t;return s<=o&&n>=r},I=(e,t)=>{const[s,n]=e,[r,o]=t;return[Math.max(s,r),Math.min(n,o)]},k=(e,t)=>{const[s,n]=e,[r,o]=t;if(d(e,t)){if(E(e,t))return!0;if(r===s)return{start:n,end:o};if(o===n)return{start:r,end:s};if(E(t,e))return{start:r,end:o};if(r<s)return{start:r,end:s};if(s<r)return{start:n,end:o}}else return{start:r,end:o};return{start:r,end:o}},b=(e,t,s)=>{const[n,r]=e,[o,i]=s,a=o-n,c=i-n;return t.slice(a,c)},U=(e,t,s)=>{for(var n=0;n<e.length;n++){const[r,o]=[e[n],t[n]];if(E(r,s))return b(r,o,s)}throw new Error("RequestSeg {requestSeg} not in {segments}")},V=e=>{for(var t=0,s=0;s<e.length;s++){const[n,r]=e[s];t+=r-n}return t},W=e=>{const[t,s]=e;return s-t},X=e=>Math.floor(e[0]+W(e)/2),B=(e,t)=>{const s=X(e),[n,r]=t,[o,i]=[s-n,r-s];return o<i?-o:i},J=(e,t)=>{for(var s=0,n=0;n<e.length;n++)if(d(e[n],t)){const[r,o]=I(e[n],t);s+=o-r}return s},$=(e,t)=>[Math.floor(e-t),Math.floor(e+t)],_=(e,t,s)=>J(s,$(e,t)),Q=(e,t,s)=>{const[n,r]=[[],[]];for(var o=0;o<e.length;o++){const[i,a]=[e[o],t[o]];if(E(s,i))n.push(i),r.push(a);else if(d(s,i))if(S(s,i)){const c=[i[0],s[1]],l=b(i,a,c);n.push(c),r.push(l)}else{const c=[s[0],i[1]],l=b(i,a,c);n.push(c),r.push(l)}}return[n,r]};class Y{constructor(){h(this,"segments",[]);h(this,"dfs",[]);h(this,"sentLength",-1);h(this,"maxSize",4e3);h(this,"trimFactor",.8);h(this,"lastRequest",[0,0])}usedSize(){return V(this.segments)}trimCache(){if(this.usedSize()<this.maxSize||this.lastRequest[0]===0&&this.lastRequest[1]===0)return;const t=this.lastRequest,n=(t[1]-t[0])/2+t[0];var r=0,o=Math.floor(this.maxSize*this.trimFactor/2);for(r=_(n,o,this.segments);r<this.maxSize;)r=_(n,o,this.segments),o*=2;const i=Math.floor(this.maxSize*this.trimFactor);for(;r>i;)o=Math.floor(.9*o),r=_(n,o,this.segments);const a=$(n,o),c=Q(this.segments,this.dfs,a);this.segments=c[0],this.dfs=c[1]}getExtents(){if(this.segments.length===0)throw new Error("No Segments");const t=this.segments[this.segments.length-1];return[this.segments[0][0],t[1]]}safeGetExtents(){if(this.segments.length===0)return[];const t=this.segments[this.segments.length-1];return[this.segments[0][0],t[1]]}addRows(t,s){const n=t[1]-t[0];if(s.length!==n){if(t[0]+s.length===this.sentLength){const i=[t[0],this.sentLength];return this.addRows(i,s)}return}const[r,o]=p(this.segments,this.dfs,t,s);this.segments=r,this.dfs=o,this.trimCache()}hasRows(t){if(t[0]===0&&t[1]===0&&console.log("setting lastRequest to [0,0] in hasRows, this is unexpected"),this.sentLength>-1&&t[1]>this.sentLength){const s=[t[0],this.sentLength];return this.hasRows(s)}this.lastRequest=t;try{console.log("[SmartRowCache.hasRows] need",t,"extents",this.safeGetExtents(),"lastRequest",this.lastRequest)}catch{}for(const s of this.segments)if(d(s,t))return k(s,t);return k([0,0],t)}getRows(t){try{console.log("[SmartRowCache.getRows] range",t,"extents",this.safeGetExtents(),"segments",this.segments)}catch{}if(this.sentLength>0&&t[1]>this.sentLength)return this.getRows([t[0],this.sentLength]);if(this.hasRows(t)===!0)return t[0]===0&&t[1]===0&&console.log("unexpected setting lastRequest to [0,0] in getRows"),this.lastRequest=t,U(this.segments,this.dfs,t);throw console.error("[SmartRowCache.getRows] Missing rows error. range",t,"extents",this.safeGetExtents(),"segments",this.segments,"sentLength",this.sentLength),new Error("Missing rows for {range}")}}function Z(e){debugger;return e.data.length!==0}class tt{constructor(t){h(this,"srcAccesses");h(this,"waitingCallbacks");h(this,"reqFn");h(this,"maxSize",1e4);h(this,"trimFactor",.8);h(this,"lastRequest",[0,0]);h(this,"reUpDist",300);h(this,"padding",200);this.reqFn=t,this.waitingCallbacks={},this.srcAccesses=new Map}usedSize(){return g.sum(Array.from(this.srcAccesses.values()).map(t=>t.usedSize()))}debugCacheState(){g.map(g.fromPairs(Array.from(this.srcAccesses.entries())),(t,s)=>{console.log(t,t.safeGetExtents())})}hasRows(t){const s=x(t),n=[t.start,t.origEnd];if(!this.srcAccesses.has(s))return console.log("500 hasRows, returning False because couldn't find srcKey"),!1;const r=this.srcAccesses.get(s);if(r===void 0)throw new Error(`unexpected couldn't find SmartRowCache for ${s}`);return r.hasRows(n)===!0?!0:(console.log("500 hasRows, returning False because src didn't have rows"),!1)}getRows(t){const s=x(t),n=[t.start,t.origEnd];if(!this.srcAccesses.has(s))throw new Error(`Missing source for ${t}`);let r=this.srcAccesses.get(s);if(r===void 0)throw new Error(`unexpected couldn't find SmartRowCache for ${s}`);if(this.srcAccesses.delete(s),this.srcAccesses.set(s,r),r.sentLength!==0&&r.sentLength<t.end){const o=Math.min(t.origEnd,r.sentLength),i=[t.start,o];return r.getRows(i)}return r.getRows(n)}maybeMakeLeadingRequest(t){const s=[t.start,t.origEnd],n=this.ensureRowCacheForPa(t),r=n.safeGetExtents();if(r[1]==n.sentLength){console.log("not making extra request because already have to the end of the available data",r,n.sentLength);return}const o=B(s,r);if(console.log("maybeMakeLeadingRequest",o,s,r),o>0&&o<this.reUpDist){const i=new Date-1,a={sourceName:t.sourceName,sort:t.sort,sort_direction:t.sort_direction,start:r[1],end:r[1]+this.padding,origEnd:r[1]+this.padding,request_time:i};n.hasRows([r[1],r[1]+this.padding]),this.reqFn(a)}}getRequestRows(t,s,n){const r=m(t),o=this.ensureRowCacheForPa(t),i=new Date-1;t.request_time=i;try{console.log("[KeyAware.getRequestRows] pa",t,"cbKey",r,"extents",o.safeGetExtents(),"sentLength",o.sentLength)}catch{}if(this.hasRows(t)){console.log(`request for ${[t.start,t.origEnd,t.end]} in cache, extents ${o.getExtents()}`);const a=[t.start,t.origEnd];s(o.getRows(a),o.sentLength);const c=m(t);delete this.waitingCallbacks[c],this.maybeMakeLeadingRequest(t);return}this.waitingCallbacks[r]=[s,n],this.reqFn(t)}ensureRowCacheForPa(t){const s=x(t);console.log("592 ensureRowCacheForPa",s,this.srcAccesses.has(s)),this.srcAccesses.has(s)||this.srcAccesses.set(s,new Y);const n=this.srcAccesses.get(s);if(n===void 0)throw new Error(`unexpected couldn't find SmartRowCache for ${s}`);return n}addPayloadResponse(t){const s=[t.key.start,t.key.end];t.key.request_time,this.trim();const n=this.ensureRowCacheForPa(t.key),r=m(t.key);if(n.sentLength=t.length,t.data.length<s[1]-s[0]){const o=[t.key.start,t.key.start+t.data.length];n.addRows(o,t.data)}else n.addRows(s,t.data);if(g.has(this.waitingCallbacks,r)){const[o,i]=this.waitingCallbacks[r];Z(t)?o(this.getRows(t.key),n.sentLength):i(),delete this.waitingCallbacks[r]}}addErrorResponse(t){const s=m(t.key);if(g.has(this.waitingCallbacks,s)){const[n,r]=this.waitingCallbacks[s];r(),delete this.waitingCallbacks[s]}}trim(){if(this.usedSize()>this.maxSize){const t=this.srcAccesses.keys().next().value;if(t!==void 0)this.srcAccesses.delete(t);else throw new Error("unexpected couldn't find any keys in srcAccesses ")}}}const R=200,st=Array.from({length:R},(e,t)=>({index:t,a:t*10,b:`row_${t}`})),et=()=>{const e=F.useMemo(()=>{const s=new tt(n=>{const r=Math.min(n.end,R);if(r<=n.start)return;const o={key:n,data:st.slice(n.start,r),length:R};setTimeout(()=>s.addPayloadResponse(o),10)});return s},[]),t=F.useMemo(()=>({datasource:j(e),data_type:"DataSource",length:R}),[e]);return C.jsx("div",{style:{height:500,width:800},children:C.jsx(H,{data_wrapper:t,df_viewer_config:nt,setActiveCol:()=>{}})})},rt={col_name:"index",header_name:"index",displayer_args:{displayer:"string"}},nt={column_config:[{col_name:"a",header_name:"a",displayer_args:{displayer:"integer",min_digits:1,max_digits:5}},{col_name:"b",header_name:"b",displayer_args:{displayer:"obj"}}],pinned_rows:[],left_col_configs:[rt]},mt={title:"Buckaroo/DFViewer/SmallDFScroll",component:et,parameters:{layout:"centered"}},w={};var v,M,A;w.parameters={...w.parameters,docs:{...(v=w.parameters)==null?void 0:v.docs,source:{originalSource:"{}",...(A=(M=w.parameters)==null?void 0:M.docs)==null?void 0:A.source}}};const wt=["Primary"];export{w as Primary,wt as __namedExportsOrder,mt as default};
