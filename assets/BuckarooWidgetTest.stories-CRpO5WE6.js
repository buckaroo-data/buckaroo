import{j as N}from"./jsx-runtime-DiklIkkE.js";import{r as L}from"./index-DRjF_FHU.js";import{C as ke,b as Ye}from"./ColumnsEditor-C6RbGg_h.js";import{S as je}from"./StatusBar-ChgSRicL.js";import{g as Ve,a as Ge}from"./gridUtils-Bae6TPFw.js";import"./MessageBox-BM_l_O3T.js";import{K as ze}from"./SmartRowCache-SXDo07If.js";import"./Operations-wB0ylO1l.js";import"./_baseEach-B-y44WsN.js";import"./isArray-Dxzbedgu.js";import"./isString-CNnovG4X.js";import"./clone-ZfB6SeuH.js";import"./OperationsList-CPVzoTey.js";import"./index.esm-DnTYv4rp.js";import"./index-DIvcuAjW.js";import"./HistogramCell-Bzivjlh2.js";import"./ChartCell-BfPIzAg-.js";import"./tiny-invariant-CopsF_GD.js";import"./fromPairs-Dx9PT-t0.js";const ie=["BOOLEAN","INT32","INT64","INT96","FLOAT","DOUBLE","BYTE_ARRAY","FIXED_LEN_BYTE_ARRAY"],O=["PLAIN","GROUP_VAR_INT","PLAIN_DICTIONARY","RLE","BIT_PACKED","DELTA_BINARY_PACKED","DELTA_LENGTH_BYTE_ARRAY","DELTA_BYTE_ARRAY","RLE_DICTIONARY","BYTE_STREAM_SPLIT"],We=["REQUIRED","OPTIONAL","REPEATED"],Ke=["UTF8","MAP","MAP_KEY_VALUE","LIST","ENUM","DECIMAL","DATE","TIME_MILLIS","TIME_MICROS","TIMESTAMP_MILLIS","TIMESTAMP_MICROS","UINT_8","UINT_16","UINT_32","UINT_64","INT_8","INT_16","INT_32","INT_64","JSON","BSON","INTERVAL"],He=["UNCOMPRESSED","SNAPPY","GZIP","LZO","BROTLI","LZ4","ZSTD","LZ4_RAW"],ye=["DATA_PAGE","INDEX_PAGE","DICTIONARY_PAGE","DATA_PAGE_V2"],Ze=["SPHERICAL","VINCENTY","THOMAS","ANDOYER","KARNEY"];function z(e){const t=C(e);if(t.type===1)return{type:"Point",coordinates:W(e,t)};if(t.type===2)return{type:"LineString",coordinates:K(e,t)};if(t.type===3)return{type:"Polygon",coordinates:se(e,t)};if(t.type===4){const n=[];for(let r=0;r<t.count;r++)n.push(W(e,C(e)));return{type:"MultiPoint",coordinates:n}}else if(t.type===5){const n=[];for(let r=0;r<t.count;r++)n.push(K(e,C(e)));return{type:"MultiLineString",coordinates:n}}else if(t.type===6){const n=[];for(let r=0;r<t.count;r++)n.push(se(e,C(e)));return{type:"MultiPolygon",coordinates:n}}else if(t.type===7){const n=[];for(let r=0;r<t.count;r++)n.push(z(e));return{type:"GeometryCollection",geometries:n}}else throw new Error(`Unsupported geometry type: ${t.type}`)}function C(e){const{view:t}=e,n=t.getUint8(e.offset++)===1,r=t.getUint32(e.offset,n);e.offset+=4;const i=r%1e3,s=Math.floor(r/1e3);let f=0;i>1&&i<=7&&(f=t.getUint32(e.offset,n),e.offset+=4);let o=2;return s&&o++,s===3&&o++,{littleEndian:n,type:i,dim:o,count:f}}function W(e,t){const n=[];for(let r=0;r<t.dim;r++){const i=e.view.getFloat64(e.offset,t.littleEndian);e.offset+=8,n.push(i)}return n}function K(e,t){const n=[];for(let r=0;r<t.count;r++)n.push(W(e,t));return n}function se(e,t){const{view:n}=e,r=[];for(let i=0;i<t.count;i++){const s=n.getUint32(e.offset,t.littleEndian);e.offset+=4,r.push(K(e,{...t,count:s}))}return r}const he=new TextDecoder,Ae={timestampFromMilliseconds(e){return new Date(Number(e))},timestampFromMicroseconds(e){return new Date(Number(e/1000n))},timestampFromNanoseconds(e){return new Date(Number(e/1000000n))},dateFromDays(e){return new Date(e*864e5)},stringFromBytes(e){return e&&he.decode(e)},geometryFromBytes(e){return e&&z({view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0})},geographyFromBytes(e){return e&&z({view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0})}};function oe(e,t,n,r){if(t&&n.endsWith("_DICTIONARY")){let i=e;e instanceof Uint8Array&&!(t instanceof Uint8Array)&&(i=new t.constructor(e.length));for(let s=0;s<e.length;s++)i[s]=t[e[s]];return i}else return be(e,r)}function be(e,t){const{element:n,parsers:r,utf8:i=!0}=t,{type:s,converted_type:f,logical_type:o}=n;if(f==="DECIMAL"){const u=10**-(n.scale||0),c=new Array(e.length);for(let l=0;l<c.length;l++)e[l]instanceof Uint8Array?c[l]=Ee(e[l])*u:c[l]=Number(e[l])*u;return c}if(!f&&s==="INT96")return Array.from(e).map(a=>r.timestampFromNanoseconds(Je(a)));if(f==="DATE")return Array.from(e).map(a=>r.dateFromDays(a));if(f==="TIMESTAMP_MILLIS")return Array.from(e).map(a=>r.timestampFromMilliseconds(a));if(f==="TIMESTAMP_MICROS")return Array.from(e).map(a=>r.timestampFromMicroseconds(a));if(f==="JSON")return e.map(a=>JSON.parse(he.decode(a)));if(f==="BSON")throw new Error("parquet bson not supported");if(f==="INTERVAL")throw new Error("parquet interval not supported");if((o==null?void 0:o.type)==="GEOMETRY")return e.map(a=>r.geometryFromBytes(a));if((o==null?void 0:o.type)==="GEOGRAPHY")return e.map(a=>r.geographyFromBytes(a));if(f==="UTF8"||(o==null?void 0:o.type)==="STRING"||i&&s==="BYTE_ARRAY")return e.map(a=>r.stringFromBytes(a));if(f==="UINT_64"||(o==null?void 0:o.type)==="INTEGER"&&o.bitWidth===64&&!o.isSigned){if(e instanceof BigInt64Array)return new BigUint64Array(e.buffer,e.byteOffset,e.length);const a=new BigUint64Array(e.length);for(let u=0;u<a.length;u++)a[u]=BigInt(e[u]);return a}if(f==="UINT_32"||(o==null?void 0:o.type)==="INTEGER"&&o.bitWidth===32&&!o.isSigned){if(e instanceof Int32Array)return new Uint32Array(e.buffer,e.byteOffset,e.length);const a=new Uint32Array(e.length);for(let u=0;u<a.length;u++)a[u]=e[u];return a}if((o==null?void 0:o.type)==="FLOAT16")return Array.from(e).map(Ie);if((o==null?void 0:o.type)==="TIMESTAMP"){const{unit:a}=o;let u=r.timestampFromMilliseconds;a==="MICROS"&&(u=r.timestampFromMicroseconds),a==="NANOS"&&(u=r.timestampFromNanoseconds);const c=new Array(e.length);for(let l=0;l<c.length;l++)c[l]=u(e[l]);return c}return e}function Ee(e){if(!e.length)return 0;let t=0n;for(const r of e)t=t*256n+BigInt(r);const n=e.length*8;return t>=2n**BigInt(n-1)&&(t-=2n**BigInt(n)),Number(t)}function Je(e){const t=(e>>64n)-2440588n,n=e&0xffffffffffffffffn;return t*86400000000000n+n}function Ie(e){if(!e)return;const t=e[1]<<8|e[0],n=t>>15?-1:1,r=t>>10&31,i=t&1023;return r===0?n*2**-14*(i/1024):r===31?i?NaN:n*(1/0):n*2**(r-15)*(1+i/1024)}function Se(e,t,n){const r=e[t],i=[];let s=1;if(r.num_children)for(;i.length<r.num_children;){const f=e[t+s],o=Se(e,t+s,[...n,f.name]);s+=o.count,i.push(o)}return{count:s,element:r,children:i,path:n}}function Re(e,t){let n=Se(e,0,[]);const r=[n];for(const i of t){const s=n.children.find(f=>f.element.name===i);if(!s)throw new Error(`parquet schema element not found: ${t}`);r.push(s),n=s}return r}function Qe(e){const t=[];function n(r){if(r.children.length)for(const i of r.children)n(i);else t.push(r.path.join("."))}return n(e),t}function ve(e){let t=0;for(const{element:n}of e)n.repetition_type==="REPEATED"&&t++;return t}function ee(e){let t=0;for(const{element:n}of e.slice(1))n.repetition_type!=="REQUIRED"&&t++;return t}function Xe(e){if(!e||e.element.converted_type!=="LIST"||e.children.length>1)return!1;const t=e.children[0];return!(t.children.length>1||t.element.repetition_type!=="REPEATED")}function et(e){if(!e||e.element.converted_type!=="MAP"||e.children.length>1)return!1;const t=e.children[0];if(t.children.length!==2||t.element.repetition_type!=="REPEATED")return!1;const n=t.children.find(i=>i.element.name==="key");if((n==null?void 0:n.element.repetition_type)==="REPEATED")return!1;const r=t.children.find(i=>i.element.name==="value");return(r==null?void 0:r.element.repetition_type)!=="REPEATED"}function De(e){if(e.length!==2)return!1;const[,t]=e;return!(t.element.repetition_type==="REPEATED"||t.children.length)}const E={STOP:0,TRUE:1,FALSE:2,BYTE:3,I16:4,I32:5,I64:6,DOUBLE:7,BINARY:8,LIST:9,STRUCT:12};function te(e){let t=0;const n={};for(;e.offset<e.view.byteLength;){const[r,i,s]=Te(e,t);if(t=s,r===E.STOP)break;n[`field_${i}`]=$(e,r)}return n}function $(e,t){switch(t){case E.TRUE:return!0;case E.FALSE:return!1;case E.BYTE:return e.view.getInt8(e.offset++);case E.I16:case E.I32:return Ne(e);case E.I64:return H(e);case E.DOUBLE:{const n=e.view.getFloat64(e.offset,!0);return e.offset+=8,n}case E.BINARY:{const n=x(e),r=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n);return e.offset+=n,r}case E.LIST:{const n=e.view.getUint8(e.offset++),r=n&15;let i=n>>4;i===15&&(i=x(e));const s=r===E.TRUE||r===E.FALSE,f=new Array(i);for(let o=0;o<i;o++)f[o]=s?$(e,E.BYTE)===1:$(e,r);return f}case E.STRUCT:{const n={};let r=0;for(;;){const[i,s,f]=Te(e,r);if(r=f,i===E.STOP)break;n[`field_${s}`]=$(e,i)}return n}default:throw new Error(`thrift unhandled type: ${t}`)}}function x(e){let t=0,n=0;for(;;){const r=e.view.getUint8(e.offset++);if(t|=(r&127)<<n,!(r&128))return t;n+=7}}function tt(e){let t=0n,n=0n;for(;;){const r=e.view.getUint8(e.offset++);if(t|=BigInt(r&127)<<n,!(r&128))return t;n+=7n}}function Ne(e){const t=x(e);return t>>>1^-(t&1)}function H(e){const t=tt(e);return t>>1n^-(t&1n)}function Te(e,t){const n=e.view.getUint8(e.offset++),r=n&15;if(r===E.STOP)return[0,0,t];const i=n>>4,s=i?t+i:Ne(e);return[r,s,s]}function nt(e,t){var s,f,o,a,u;const n=new Map,r=(s=t==null?void 0:t.find(({key:c})=>c==="geo"))==null?void 0:s.value,i=(r&&((f=JSON.parse(r))==null?void 0:f.columns))??{};for(const[c,l]of Object.entries(i)){if(l.encoding!=="WKB")continue;const d=l.edges==="spherical"?"GEOGRAPHY":"GEOMETRY",_=((o=l.crs)==null?void 0:o.id)??((u=(a=l.crs)==null?void 0:a.ids)==null?void 0:u[0]),w=_?`${_.authority}:${_.code.toString()}`:void 0;n.set(c,{type:d,crs:w})}for(let c=1;c<e.length;c++){const l=e[c],{logical_type:d,name:_,num_children:w,repetition_type:y,type:p}=l;if(w){c+=w;continue}p==="BYTE_ARRAY"&&d===void 0&&y!=="REPEATED"&&(l.logical_type=n.get(_))}}const rt=1<<19,it=new TextDecoder;function v(e){return e&&it.decode(e)}async function st(e,{parsers:t,initialFetchSize:n=rt,geoparquet:r=!0}={}){if(!e||!(e.byteLength>=0))throw new Error("parquet expected AsyncBuffer");const i=Math.max(0,e.byteLength-n),s=await e.slice(i,e.byteLength),f=new DataView(s);if(f.getUint32(s.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");const o=f.getUint32(s.byteLength-8,!0);if(o>e.byteLength-8)throw new Error(`parquet metadata length ${o} exceeds available buffer ${e.byteLength-8}`);if(o+8>n){const a=e.byteLength-o-8,u=await e.slice(a,i),c=new ArrayBuffer(o+8),l=new Uint8Array(c);return l.set(new Uint8Array(u)),l.set(new Uint8Array(s),i-a),Z(c,{parsers:t,geoparquet:r})}else return Z(s,{parsers:t,geoparquet:r})}function Z(e,{parsers:t,geoparquet:n=!0}={}){var p;if(!(e instanceof ArrayBuffer))throw new Error("parquet expected ArrayBuffer");const r=new DataView(e);if(t={...Ae,...t},r.byteLength<8)throw new Error("parquet file is too short");if(r.getUint32(r.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");const i=r.byteLength-8,s=r.getUint32(i,!0);if(s>r.byteLength-8)throw new Error(`parquet metadata length ${s} exceeds available buffer ${r.byteLength-8}`);const f=i-s,a=te({view:r,offset:f}),u=a.field_1,c=a.field_2.map(m=>({type:ie[m.field_1],type_length:m.field_2,repetition_type:We[m.field_3],name:v(m.field_4),num_children:m.field_5,converted_type:Ke[m.field_6],scale:m.field_7,precision:m.field_8,field_id:m.field_9,logical_type:ot(m.field_10)})),l=c.filter(m=>m.type),d=a.field_3,_=a.field_4.map(m=>{var h;return{columns:m.field_1.map((g,A)=>{var I,R,S;return{file_path:v(g.field_1),file_offset:g.field_2,meta_data:g.field_3&&{type:ie[g.field_3.field_1],encodings:(I=g.field_3.field_2)==null?void 0:I.map(b=>O[b]),path_in_schema:g.field_3.field_3.map(v),codec:He[g.field_3.field_4],num_values:g.field_3.field_5,total_uncompressed_size:g.field_3.field_6,total_compressed_size:g.field_3.field_7,key_value_metadata:(R=g.field_3.field_8)==null?void 0:R.map(b=>({key:v(b.field_1),value:v(b.field_2)})),data_page_offset:g.field_3.field_9,index_page_offset:g.field_3.field_10,dictionary_page_offset:g.field_3.field_11,statistics:ft(g.field_3.field_12,l[A],t),encoding_stats:(S=g.field_3.field_13)==null?void 0:S.map(b=>({page_type:ye[b.field_1],encoding:O[b.field_2],count:b.field_3})),bloom_filter_offset:g.field_3.field_14,bloom_filter_length:g.field_3.field_15,size_statistics:g.field_3.field_16&&{unencoded_byte_array_data_bytes:g.field_3.field_16.field_1,repetition_level_histogram:g.field_3.field_16.field_2,definition_level_histogram:g.field_3.field_16.field_3},geospatial_statistics:g.field_3.field_17&&{bbox:g.field_3.field_17.field_1&&{xmin:g.field_3.field_17.field_1.field_1,xmax:g.field_3.field_17.field_1.field_2,ymin:g.field_3.field_17.field_1.field_3,ymax:g.field_3.field_17.field_1.field_4,zmin:g.field_3.field_17.field_1.field_5,zmax:g.field_3.field_17.field_1.field_6,mmin:g.field_3.field_17.field_1.field_7,mmax:g.field_3.field_17.field_1.field_8},geospatial_types:g.field_3.field_17.field_2}},offset_index_offset:g.field_4,offset_index_length:g.field_5,column_index_offset:g.field_6,column_index_length:g.field_7,crypto_metadata:g.field_8,encrypted_column_metadata:g.field_9}}),total_byte_size:m.field_2,num_rows:m.field_3,sorting_columns:(h=m.field_4)==null?void 0:h.map(g=>({column_idx:g.field_1,descending:g.field_2,nulls_first:g.field_3})),file_offset:m.field_5,total_compressed_size:m.field_6,ordinal:m.field_7}}),w=(p=a.field_5)==null?void 0:p.map(m=>({key:v(m.field_1),value:v(m.field_2)})),y=v(a.field_6);return n&&nt(c,w),{version:u,schema:c,num_rows:d,row_groups:_,key_value_metadata:w,created_by:y,metadata_length:s}}function J({schema:e}){return Re(e,[])[0]}function ot(e){return e!=null&&e.field_1?{type:"STRING"}:e!=null&&e.field_2?{type:"MAP"}:e!=null&&e.field_3?{type:"LIST"}:e!=null&&e.field_4?{type:"ENUM"}:e!=null&&e.field_5?{type:"DECIMAL",scale:e.field_5.field_1,precision:e.field_5.field_2}:e!=null&&e.field_6?{type:"DATE"}:e!=null&&e.field_7?{type:"TIME",isAdjustedToUTC:e.field_7.field_1,unit:fe(e.field_7.field_2)}:e!=null&&e.field_8?{type:"TIMESTAMP",isAdjustedToUTC:e.field_8.field_1,unit:fe(e.field_8.field_2)}:e!=null&&e.field_10?{type:"INTEGER",bitWidth:e.field_10.field_1,isSigned:e.field_10.field_2}:e!=null&&e.field_11?{type:"NULL"}:e!=null&&e.field_12?{type:"JSON"}:e!=null&&e.field_13?{type:"BSON"}:e!=null&&e.field_14?{type:"UUID"}:e!=null&&e.field_15?{type:"FLOAT16"}:e!=null&&e.field_16?{type:"VARIANT",specification_version:e.field_16.field_1}:e!=null&&e.field_17?{type:"GEOMETRY",crs:v(e.field_17.field_1)}:e!=null&&e.field_18?{type:"GEOGRAPHY",crs:v(e.field_18.field_1),algorithm:Ze[e.field_18.field_2]}:e}function fe(e){if(e.field_1)return"MILLIS";if(e.field_2)return"MICROS";if(e.field_3)return"NANOS";throw new Error("parquet time unit required")}function ft(e,t,n){return e&&{max:F(e.field_1,t,n),min:F(e.field_2,t,n),null_count:e.field_3,distinct_count:e.field_4,max_value:F(e.field_5,t,n),min_value:F(e.field_6,t,n),is_max_value_exact:e.field_7,is_min_value_exact:e.field_8}}function F(e,t,n){const{type:r,converted_type:i,logical_type:s}=t;if(e===void 0)return e;if(r==="BOOLEAN")return e[0]===1;if(r==="BYTE_ARRAY")return n.stringFromBytes(e);const f=new DataView(e.buffer,e.byteOffset,e.byteLength);return r==="FLOAT"&&f.byteLength===4?f.getFloat32(0,!0):r==="DOUBLE"&&f.byteLength===8?f.getFloat64(0,!0):r==="INT32"&&i==="DATE"?n.dateFromDays(f.getInt32(0,!0)):r==="INT64"&&i==="TIMESTAMP_MILLIS"?n.timestampFromMilliseconds(f.getBigInt64(0,!0)):r==="INT64"&&i==="TIMESTAMP_MICROS"?n.timestampFromMicroseconds(f.getBigInt64(0,!0)):r==="INT64"&&(s==null?void 0:s.type)==="TIMESTAMP"&&(s==null?void 0:s.unit)==="NANOS"?n.timestampFromNanoseconds(f.getBigInt64(0,!0)):r==="INT64"&&(s==null?void 0:s.type)==="TIMESTAMP"&&(s==null?void 0:s.unit)==="MICROS"?n.timestampFromMicroseconds(f.getBigInt64(0,!0)):r==="INT64"&&(s==null?void 0:s.type)==="TIMESTAMP"?n.timestampFromMilliseconds(f.getBigInt64(0,!0)):r==="INT32"&&f.byteLength===4?f.getInt32(0,!0):r==="INT64"&&f.byteLength===8?f.getBigInt64(0,!0):i==="DECIMAL"?Ee(e)*10**-(t.scale||0):(s==null?void 0:s.type)==="FLOAT16"?Ie(e):e}function at(e){const t=te(e);return{page_locations:t.field_1.map(lt),unencoded_byte_array_data_bytes:t.field_2}}function lt(e){return{offset:e.field_1,compressed_page_size:e.field_2,first_row_index:e.field_3}}function Oe(e,t){for(let r=0;r<t.length;r+=1e4)e.push(...t.slice(r,r+1e4))}function D(e,t,n=!0){if(n?e===t:e==t)return!0;if(e instanceof Uint8Array&&t instanceof Uint8Array)return D(Array.from(e),Array.from(t),n);if(!e||!t||typeof e!=typeof t)return!1;if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!D(e[i],t[i],n))return!1;return!0}if(typeof e!="object")return!1;const r=Object.keys(e);if(r.length!==Object.keys(t).length)return!1;for(const i of r)if(!D(e[i],t[i],n))return!1;return!0}function Le(e){if(!e)return[];if(e.length===1)return e[0];const t=[];for(const n of e)Oe(t,n);return t}function k(e){if(!e)return[];const t=[];return"$and"in e&&Array.isArray(e.$and)?t.push(...e.$and.flatMap(k)):"$or"in e&&Array.isArray(e.$or)?t.push(...e.$or.flatMap(k)):"$nor"in e&&Array.isArray(e.$nor)?t.push(...e.$nor.flatMap(k)):t.push(...Object.keys(e)),t}function B(e,t,n=!0){return"$and"in t&&Array.isArray(t.$and)?t.$and.every(r=>B(e,r,n)):"$or"in t&&Array.isArray(t.$or)?t.$or.some(r=>B(e,r,n)):"$nor"in t&&Array.isArray(t.$nor)?!t.$nor.some(r=>B(e,r,n)):Object.entries(t).every(([r,i])=>{const s=e[r];return typeof i!="object"||i===null||Array.isArray(i)?D(s,i,n):Object.entries(i||{}).every(([f,o])=>f==="$gt"?s>o:f==="$gte"?s>=o:f==="$lt"?s<o:f==="$lte"?s<=o:f==="$eq"?D(s,o,n):f==="$ne"?!D(s,o,n):f==="$in"?Array.isArray(o)&&o.includes(s):f==="$nin"?Array.isArray(o)&&!o.includes(s):f==="$not"?!B({[r]:s},{[r]:o},n):!0)})}function Q({rowGroup:e,physicalColumns:t,filter:n,strict:r=!0}){var i;if(!n)return!1;if("$and"in n&&Array.isArray(n.$and))return n.$and.some(s=>Q({rowGroup:e,physicalColumns:t,filter:s,strict:r}));if("$or"in n&&Array.isArray(n.$or))return n.$or.every(s=>Q({rowGroup:e,physicalColumns:t,filter:s,strict:r}));if("$nor"in n&&Array.isArray(n.$nor))return!1;for(const[s,f]of Object.entries(n)){const o=t.indexOf(s);if(o===-1)continue;const a=(i=e.columns[o].meta_data)==null?void 0:i.statistics;if(!a)continue;const{min:u,max:c,min_value:l,max_value:d}=a,_=l!==void 0?l:u,w=d!==void 0?d:c;if(!(_===void 0||w===void 0)){for(const[y,p]of Object.entries(f||{}))if(y==="$gt"&&w<=p||y==="$gte"&&w<p||y==="$lt"&&_>=p||y==="$lte"&&_>p||y==="$eq"&&(p<_||p>w)||y==="$ne"&&D(_,w,r)&&D(_,p,r)||y==="$in"&&Array.isArray(p)&&p.every(m=>m<_||m>w)||y==="$nin"&&Array.isArray(p)&&D(_,w,r)&&p.includes(_))return!0}}return!1}const ut=1<<21;function ct({metadata:e,rowStart:t=0,rowEnd:n=1/0,columns:r,filter:i,filterStrict:s=!0,useOffsetIndex:f=!1}){if(!e)throw new Error("parquetPlan requires metadata");const o=[],a=[],u=[],c=Qe(J(e));let l=0;for(const d of e.row_groups){const _=Number(d.num_rows),w=l+_;if(_>0&&w>t&&l<n&&!Q({rowGroup:d,physicalColumns:c,filter:i,strict:s})){const y=[];for(const g of d.columns){const A=g.meta_data;if(g.file_path)throw new Error("parquet file_path not supported");if(!A)throw new Error("parquet column metadata is undefined");if(!r||r.includes(A.path_in_schema[0])){const I=A.dictionary_page_offset||A.data_page_offset,R=Number(I),S=Number(I+A.total_compressed_size);if(f&&g.offset_index_offset&&g.offset_index_length){const b=Number(g.offset_index_offset);y.push({columnMetadata:A,offsetIndex:{startByte:b,endByte:b+g.offset_index_length},bounds:{startByte:R,endByte:S}})}else y.push({columnMetadata:A,range:{startByte:R,endByte:S}})}}const p=Math.max(t-l,0),m=Math.min(n-l,_);o.push({chunks:y,rowGroup:d,groupStart:l,groupRows:_,selectStart:p,selectEnd:m});let h;for(const g of y)if("offsetIndex"in g)u.push(g.offsetIndex);else{const{range:A}=g;r?a.push(A):h&&A.endByte-h.startByte<=ut?h.endByte=A.endByte:(h&&a.push(h),h={...A})}h&&a.push(h)}l=w}return isFinite(n)||(n=l),a.push(...u),{metadata:e,rowStart:t,rowEnd:n,columns:r,fetches:a,groups:o}}function mt(e,{fetches:t}){const n=t.map(({startByte:r,endByte:i})=>e.slice(r,i));return{byteLength:e.byteLength,slice(r,i=e.byteLength){const s=t.findIndex(({startByte:f,endByte:o})=>f<=r&&i<=o);if(s<0)return e.slice(r,i);if(t[s].startByte!==r||t[s].endByte!==i){const f=r-t[s].startByte,o=i-t[s].startByte;return n[s]instanceof Promise?n[s].then(a=>a.slice(f,o)):n[s].slice(f,o)}else return n[s]}}}function ae(e,t,n,r,i){const s=(t==null?void 0:t.length)||n.length;if(!s)return r;const f=ee(i),o=i.map(({element:w})=>w.repetition_type);let a=0;const u=[e];let c=e,l=0,d=0,_=0;if(n[0])for(;l<o.length-2&&_<n[0];)l++,o[l]!=="REQUIRED"&&(c=c.at(-1),u.push(c),d++),o[l]==="REPEATED"&&_++;for(let w=0;w<s;w++){const y=t!=null&&t.length?t[w]:f,p=n[w];for(;l&&(p<_||o[l]!=="REPEATED");)o[l]!=="REQUIRED"&&(u.pop(),d--),o[l]==="REPEATED"&&_--,l--;for(c=u.at(-1);(l<o.length-2||o[l+1]==="REPEATED")&&(d<y||o[l+1]==="REQUIRED");){if(l++,o[l]!=="REQUIRED"){const m=[];c.push(m),c=m,u.push(m),d++}o[l]==="REPEATED"&&_++}y===f?c.push(r[a++]):l===o.length-2?c.push(null):c.push([])}if(!e.length)for(let w=0;w<f;w++){const y=[];c.push(y),c=y}return e}function P(e,t,n=0){const r=t.path.join("."),i=t.element.repetition_type==="OPTIONAL",s=i?n+1:n;if(Xe(t)){let f=t.children[0],o=s;f.children.length===1&&(f=f.children[0],o++),P(e,f,o);const a=f.path.join("."),u=e.get(a);if(!u)throw new Error("parquet list column missing values");i&&Y(u,n),e.set(r,u),e.delete(a);return}if(et(t)){const f=t.children[0].element.name;P(e,t.children[0].children[0],s+1),P(e,t.children[0].children[1],s+1);const o=e.get(`${r}.${f}.key`),a=e.get(`${r}.${f}.value`);if(!o)throw new Error("parquet map column missing keys");if(!a)throw new Error("parquet map column missing values");if(o.length!==a.length)throw new Error("parquet map column key/value length mismatch");const u=xe(o,a,s);i&&Y(u,n),e.delete(`${r}.${f}.key`),e.delete(`${r}.${f}.value`),e.set(r,u);return}if(t.children.length){const f=t.element.repetition_type==="REQUIRED"?n:n+1,o={};for(const u of t.children){P(e,u,f);const c=e.get(u.path.join("."));if(!c)throw new Error("parquet struct missing child data");o[u.element.name]=c}for(const u of t.children)e.delete(u.path.join("."));const a=Be(o,f);i&&Y(a,n),e.set(r,a)}}function Y(e,t){for(let n=0;n<e.length;n++)t?Y(e[n],t-1):e[n]=e[n][0]}function xe(e,t,n){const r=[];for(let i=0;i<e.length;i++)if(n)r.push(xe(e[i],t[i],n-1));else if(e[i]){const s={};for(let f=0;f<e[i].length;f++){const o=t[i][f];s[e[i][f]]=o===void 0?null:o}r.push(s)}else r.push(void 0);return r}function Be(e,t){var s;const n=Object.keys(e),r=(s=e[n[0]])==null?void 0:s.length,i=[];for(let f=0;f<r;f++){const o={};for(const a of n){if(e[a].length!==r)throw new Error("parquet struct parsing error");o[a]=e[a][f]}t?i.push(Be(o,t-1)):i.push(o)}return i}function U(e,t,n){const r=n instanceof Int32Array,i=x(e),s=x(e);x(e);let f=H(e),o=0;n[o++]=r?Number(f):f;const a=i/s;for(;o<t;){const u=H(e),c=new Uint8Array(s);for(let l=0;l<s;l++)c[l]=e.view.getUint8(e.offset++);for(let l=0;l<s&&o<t;l++){const d=BigInt(c[l]);if(d){let _=0n,w=a;const y=(1n<<d)-1n;for(;w&&o<t;){let p=BigInt(e.view.getUint8(e.offset))>>_&y;for(_+=d;_>=8;)_-=8n,e.offset++,_&&(p|=BigInt(e.view.getUint8(e.offset))<<d-_&y);const m=u+p;f+=m,n[o++]=r?Number(f):f,w--}w&&(e.offset+=Math.ceil((w*Number(d)+Number(_))/8))}else for(let _=0;_<a&&o<t;_++)f+=u,n[o++]=r?Number(f):f}}}function Pe(e,t,n){const r=new Int32Array(t);U(e,t,r);for(let i=0;i<t;i++)n[i]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,r[i]),e.offset+=r[i]}function dt(e,t,n){const r=new Int32Array(t);U(e,t,r);const i=new Int32Array(t);U(e,t,i);for(let s=0;s<t;s++){const f=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,i[s]);r[s]?(n[s]=new Uint8Array(r[s]+i[s]),n[s].set(n[s-1].subarray(0,r[s])),n[s].set(f,r[s])):n[s]=f,e.offset+=i[s]}}function j(e){return 32-Math.clz32(e)}function T(e,t,n,r){r===void 0&&(r=e.view.getUint32(e.offset,!0),e.offset+=4);const i=e.offset;let s=0;for(;s<n.length;){const f=x(e);if(f&1)s=gt(e,f,t,n,s);else{const o=f>>>1;_t(e,o,t,n,s),s+=o}}e.offset=i+r}function _t(e,t,n,r,i){const s=n+7>>3;let f=0;for(let o=0;o<s;o++)f|=e.view.getUint8(e.offset++)<<(o<<3);for(let o=0;o<t;o++)r[i+o]=f}function gt(e,t,n,r,i){let s=t>>1<<3;const f=(1<<n)-1;let o=0;if(e.offset<e.view.byteLength)o=e.view.getUint8(e.offset++);else if(f)throw new Error(`parquet bitpack offset ${e.offset} out of range`);let a=8,u=0;for(;s;)u>8?(u-=8,a-=8,o>>>=8):a-u<n?(o|=e.view.getUint8(e.offset)<<a,e.offset++,a+=8):(i<r.length&&(r[i++]=o>>u&f),s--,u+=n);return i}function Me(e,t,n,r){const i=pt(n,r),s=new Uint8Array(t*i);for(let f=0;f<i;f++)for(let o=0;o<t;o++)s[o*i+f]=e.view.getUint8(e.offset++);if(n==="FLOAT")return new Float32Array(s.buffer);if(n==="DOUBLE")return new Float64Array(s.buffer);if(n==="INT32")return new Int32Array(s.buffer);if(n==="INT64")return new BigInt64Array(s.buffer);if(n==="FIXED_LEN_BYTE_ARRAY"){const f=new Array(t);for(let o=0;o<t;o++)f[o]=s.subarray(o*i,(o+1)*i);return f}throw new Error(`parquet byte_stream_split unsupported type: ${n}`)}function pt(e,t){switch(e){case"INT32":case"FLOAT":return 4;case"INT64":case"DOUBLE":return 8;case"FIXED_LEN_BYTE_ARRAY":if(!t)throw new Error("parquet byteWidth missing type_length");return t;default:throw new Error(`parquet unsupported type: ${e}`)}}function ne(e,t,n,r){if(n===0)return[];if(t==="BOOLEAN")return wt(e,n);if(t==="INT32")return yt(e,n);if(t==="INT64")return ht(e,n);if(t==="INT96")return At(e,n);if(t==="FLOAT")return bt(e,n);if(t==="DOUBLE")return Et(e,n);if(t==="BYTE_ARRAY")return It(e,n);if(t==="FIXED_LEN_BYTE_ARRAY"){if(!r)throw new Error("parquet missing fixed length");return St(e,n,r)}else throw new Error(`parquet unhandled type: ${t}`)}function wt(e,t){const n=new Array(t);for(let r=0;r<t;r++){const i=e.offset+(r/8|0),s=r%8,f=e.view.getUint8(i);n[r]=(f&1<<s)!==0}return e.offset+=Math.ceil(t/8),n}function yt(e,t){const n=(e.view.byteOffset+e.offset)%4?new Int32Array(V(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Int32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function ht(e,t){const n=(e.view.byteOffset+e.offset)%8?new BigInt64Array(V(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new BigInt64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function At(e,t){const n=new Array(t);for(let r=0;r<t;r++){const i=e.view.getBigInt64(e.offset+r*12,!0),s=e.view.getInt32(e.offset+r*12+8,!0);n[r]=BigInt(s)<<64n|i}return e.offset+=t*12,n}function bt(e,t){const n=(e.view.byteOffset+e.offset)%4?new Float32Array(V(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Float32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function Et(e,t){const n=(e.view.byteOffset+e.offset)%8?new Float64Array(V(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new Float64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function It(e,t){const n=new Array(t);for(let r=0;r<t;r++){const i=e.view.getUint32(e.offset,!0);e.offset+=4,n[r]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,i),e.offset+=i}return n}function St(e,t,n){const r=new Array(t);for(let i=0;i<t;i++)r[i]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n),e.offset+=n;return r}function V(e,t,n){const r=new ArrayBuffer(n);return new Uint8Array(r).set(new Uint8Array(e,t,n)),r}const Rt=[0,255,65535,16777215,4294967295];function le(e,t,n,r,i){for(let s=0;s<i;s++)n[r+s]=e[t+s]}function vt(e,t){const n=e.byteLength,r=t.byteLength;let i=0,s=0;for(;i<n;){const f=e[i];if(i++,f<128)break}if(r&&i>=n)throw new Error("invalid snappy length header");for(;i<n;){const f=e[i];let o=0;if(i++,i>=n)throw new Error("missing eof marker");if(f&3){let a=0;switch(f&3){case 1:o=(f>>>2&7)+4,a=e[i]+(f>>>5<<8),i++;break;case 2:if(n<=i+1)throw new Error("snappy error end of input");o=(f>>>2)+1,a=e[i]+(e[i+1]<<8),i+=2;break;case 3:if(n<=i+3)throw new Error("snappy error end of input");o=(f>>>2)+1,a=e[i]+(e[i+1]<<8)+(e[i+2]<<16)+(e[i+3]<<24),i+=4;break}if(a===0||isNaN(a))throw new Error(`invalid offset ${a} pos ${i} inputLength ${n}`);if(a>s)throw new Error("cannot copy from before start of buffer");le(t,s-a,t,s,o),s+=o}else{let a=(f>>>2)+1;if(a>60){if(i+3>=n)throw new Error("snappy error literal pos + 3 >= inputLength");const u=a-60;a=e[i]+(e[i+1]<<8)+(e[i+2]<<16)+(e[i+3]<<24),a=(a&Rt[u])+1,i+=u}if(i+a>n)throw new Error("snappy error literal exceeds input length");le(e,i,t,s,a),i+=a,s+=a}}if(s!==r)throw new Error("premature end of input")}function Dt(e,t,{type:n,element:r,schemaPath:i}){const s=new DataView(e.buffer,e.byteOffset,e.byteLength),f={view:s,offset:0};let o;const a=Nt(f,t,i),{definitionLevels:u,numNulls:c}=Tt(f,t,i),l=t.num_values-c;if(t.encoding==="PLAIN")o=ne(f,n,l,r.type_length);else if(t.encoding==="PLAIN_DICTIONARY"||t.encoding==="RLE_DICTIONARY"||t.encoding==="RLE"){const d=n==="BOOLEAN"?1:s.getUint8(f.offset++);d?(o=new Array(l),n==="BOOLEAN"?(T(f,d,o),o=o.map(_=>!!_)):T(f,d,o,s.byteLength-f.offset)):o=new Uint8Array(l)}else if(t.encoding==="BYTE_STREAM_SPLIT")o=Me(f,l,n,r.type_length);else if(t.encoding==="DELTA_BINARY_PACKED")o=n==="INT32"?new Int32Array(l):new BigInt64Array(l),U(f,l,o);else if(t.encoding==="DELTA_LENGTH_BYTE_ARRAY")o=new Array(l),Pe(f,l,o);else throw new Error(`parquet unsupported encoding: ${t.encoding}`);return{definitionLevels:u,repetitionLevels:a,dataPage:o}}function Nt(e,t,n){if(n.length>1){const r=ve(n);if(r){const i=new Array(t.num_values);return T(e,j(r),i),i}}return[]}function Tt(e,t,n){const r=ee(n);if(!r)return{definitionLevels:[],numNulls:0};const i=new Array(t.num_values);T(e,j(r),i);let s=t.num_values;for(const f of i)f===r&&s--;return s===0&&(i.length=0),{definitionLevels:i,numNulls:s}}function X(e,t,n,r){let i;const s=r==null?void 0:r[n];if(n==="UNCOMPRESSED")i=e;else if(s)i=s(e,t);else if(n==="SNAPPY")i=new Uint8Array(t),vt(e,i);else throw new Error(`parquet unsupported compression codec: ${n}`);if((i==null?void 0:i.length)!==t)throw new Error(`parquet decompressed page length ${i==null?void 0:i.length} does not match header ${t}`);return i}function Ot(e,t,n){const i={view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0},{type:s,element:f,schemaPath:o,codec:a,compressors:u}=n,c=t.data_page_header_v2;if(!c)throw new Error("parquet data page header v2 is undefined");const l=Lt(i,c,o);i.offset=c.repetition_levels_byte_length;const d=xt(i,c,o),_=t.uncompressed_page_size-c.definition_levels_byte_length-c.repetition_levels_byte_length;let w=e.subarray(i.offset);c.is_compressed!==!1&&(w=X(w,_,a,u));const y=new DataView(w.buffer,w.byteOffset,w.byteLength),p={view:y,offset:0};let m;const h=c.num_values-c.num_nulls;if(c.encoding==="PLAIN")m=ne(p,s,h,f.type_length);else if(c.encoding==="RLE")m=new Array(h),T(p,1,m),m=m.map(g=>!!g);else if(c.encoding==="PLAIN_DICTIONARY"||c.encoding==="RLE_DICTIONARY"){const g=y.getUint8(p.offset++);m=new Array(h),T(p,g,m,_-1)}else if(c.encoding==="DELTA_BINARY_PACKED")m=s==="INT32"?new Int32Array(h):new BigInt64Array(h),U(p,h,m);else if(c.encoding==="DELTA_LENGTH_BYTE_ARRAY")m=new Array(h),Pe(p,h,m);else if(c.encoding==="DELTA_BYTE_ARRAY")m=new Array(h),dt(p,h,m);else if(c.encoding==="BYTE_STREAM_SPLIT")m=Me(p,h,s,f.type_length);else throw new Error(`parquet unsupported encoding: ${c.encoding}`);return{definitionLevels:d,repetitionLevels:l,dataPage:m}}function Lt(e,t,n){const r=ve(n);if(!r)return[];const i=new Array(t.num_values);return T(e,j(r),i,t.repetition_levels_byte_length),i}function xt(e,t,n){const r=ee(n);if(r){const i=new Array(t.num_values);return T(e,j(r),i,t.definition_levels_byte_length),i}}function ue(e,{groupStart:t,selectStart:n,selectEnd:r},i,s){const{pathInSchema:f,schemaPath:o}=i,a=De(o),u=[];let c,l,d=0;const _=s&&(()=>{l&&s({pathInSchema:f,columnData:l,rowStart:t+d-l.length,rowEnd:t+d})});for(;(a?d<r:e.offset<e.view.byteLength-1)&&!(e.offset>=e.view.byteLength-1);){const w=Bt(e);if(w.type==="DICTIONARY_PAGE")c=ce(e,w,i,c,void 0,0),c=be(c,i);else{const y=(l==null?void 0:l.length)||0,p=ce(e,w,i,c,l,n-d);l===p?d+=p.length-y:(_==null||_(),u.push(p),d+=p.length,l=p)}}return _==null||_(),u}function ce(e,t,n,r,i,s){const{type:f,element:o,schemaPath:a,codec:u,compressors:c}=n,l=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,t.compressed_page_size);if(e.offset+=t.compressed_page_size,t.type==="DATA_PAGE"){const d=t.data_page_header;if(!d)throw new Error("parquet data page header is undefined");if(s>d.num_values&&De(a))return new Array(d.num_values);const _=X(l,Number(t.uncompressed_page_size),u,c),{definitionLevels:w,repetitionLevels:y,dataPage:p}=Dt(_,d,n);let m=oe(p,r,d.encoding,n);if(y.length||w!=null&&w.length){const h=Array.isArray(i)?i:[];return ae(h,w,y,m,a)}else{for(let h=2;h<a.length;h++)a[h].element.repetition_type!=="REQUIRED"&&(m=Array.from(m,g=>[g]));return m}}else if(t.type==="DATA_PAGE_V2"){const d=t.data_page_header_v2;if(!d)throw new Error("parquet data page header v2 is undefined");if(s>d.num_rows)return new Array(d.num_values);const{definitionLevels:_,repetitionLevels:w,dataPage:y}=Ot(l,t,n),p=oe(y,r,d.encoding,n),m=Array.isArray(i)?i:[];return ae(m,_,w,p,a)}else if(t.type==="DICTIONARY_PAGE"){const d=t.dictionary_page_header;if(!d)throw new Error("parquet dictionary page header is undefined");const _=X(l,Number(t.uncompressed_page_size),u,c),w={view:new DataView(_.buffer,_.byteOffset,_.byteLength),offset:0};return ne(w,f,d.num_values,o.type_length)}else throw new Error(`parquet unsupported page type: ${t.type}`)}function Bt(e){const t=te(e),n=ye[t.field_1],r=t.field_2,i=t.field_3,s=t.field_4,f=t.field_5&&{num_values:t.field_5.field_1,encoding:O[t.field_5.field_2],definition_level_encoding:O[t.field_5.field_3],repetition_level_encoding:O[t.field_5.field_4],statistics:t.field_5.field_5&&{max:t.field_5.field_5.field_1,min:t.field_5.field_5.field_2,null_count:t.field_5.field_5.field_3,distinct_count:t.field_5.field_5.field_4,max_value:t.field_5.field_5.field_5,min_value:t.field_5.field_5.field_6}},o=t.field_6,a=t.field_7&&{num_values:t.field_7.field_1,encoding:O[t.field_7.field_2],is_sorted:t.field_7.field_3},u=t.field_8&&{num_values:t.field_8.field_1,num_nulls:t.field_8.field_2,num_rows:t.field_8.field_3,encoding:O[t.field_8.field_4],definition_levels_byte_length:t.field_8.field_5,repetition_levels_byte_length:t.field_8.field_6,is_compressed:t.field_8.field_7===void 0?!0:t.field_8.field_7,statistics:t.field_8.field_8};return{type:n,uncompressed_page_size:r,compressed_page_size:i,crc:s,data_page_header:f,index_page_header:o,dictionary_page_header:a,data_page_header_v2:u}}function Pt(e,{metadata:t},n){const{file:r,compressors:i,utf8:s}=e,f=[],o={...Ae,...e.parsers};for(const a of n.chunks){const{columnMetadata:u}=a,c=Re(t.schema,u.path_in_schema),l={pathInSchema:u.path_in_schema,type:u.type,element:c[c.length-1].element,schemaPath:c,codec:u.codec,parsers:o,compressors:i,utf8:s};if(!("offsetIndex"in a)){f.push({pathInSchema:u.path_in_schema,data:Promise.resolve(r.slice(a.range.startByte,a.range.endByte)).then(d=>{const _={view:new DataView(d),offset:0};return{pageSkip:0,data:ue(_,n,l,e.onPage)}})});continue}f.push({pathInSchema:u.path_in_schema,data:Promise.resolve(r.slice(a.offsetIndex.startByte,a.offsetIndex.endByte)).then(async d=>{const _=at({view:new DataView(d),offset:0}),{selectStart:w,selectEnd:y}=n,p=_.page_locations;let m=NaN,h=NaN,g=0;for(let S=0;S<p.length;S++){const b=p[S],re=Number(b.first_row_index),$e=S+1<p.length?Number(p[S+1].first_row_index):n.groupRows;re<y&&$e>w&&(Number.isNaN(m)&&(m=Number(b.offset),g=re),h=Number(b.offset)+b.compressed_page_size)}const A=await r.slice(m,h),I={view:new DataView(A),offset:0},R=g?{...n,groupStart:n.groupStart+g,selectStart:n.selectStart-g,selectEnd:n.selectEnd-g}:n;return{data:ue(I,R,l,e.onPage),pageSkip:g}})})}return{groupStart:n.groupStart,groupRows:n.groupRows,asyncColumns:f}}async function me({asyncColumns:e},t,n,r,i){const s=await Promise.all(e.map(async({data:l})=>{const d=await l;return{...d,data:Le(d.data)}})),f=e.map(l=>l.pathInSchema[0]).filter(l=>!r||r.includes(l)),o=r??f,a=o.map(l=>e.findIndex(d=>d.pathInSchema[0]===l)),u=n-t;if(i==="object"){const l=Array(u);for(let d=0;d<u;d++){const _=t+d,w={};for(let y=0;y<e.length;y++){const{data:p,pageSkip:m}=s[y];w[e[y].pathInSchema[0]]=p[_-m]}l[d]=w}return l}const c=Array(u);for(let l=0;l<u;l++){const d=t+l,_=Array(e.length);for(let w=0;w<o.length;w++){const y=a[w];if(y>=0){const{data:p,pageSkip:m}=s[y];_[w]=p[d-m]}}c[l]=_}return c}function Mt(e,t){const{asyncColumns:n}=e,r=[];for(const i of t.children)if(i.children.length){const s=n.filter(a=>a.pathInSchema[0]===i.element.name);if(!s.length)continue;const f=new Map,o=Promise.all(s.map(a=>a.data.then(({data:u})=>{f.set(a.pathInSchema.join("."),Le(u))}))).then(()=>{P(f,i);const a=f.get(i.path.join("."));if(!a)throw new Error("parquet column data not assembled");return{data:[a],pageSkip:0}});r.push({pathInSchema:i.path,data:o})}else{const s=n.find(f=>f.pathInSchema[0]===i.element.name);s&&r.push(s)}return{...e,asyncColumns:r}}async function Ut(e){e.metadata??(e.metadata=await st(e.file,e));const{rowStart:t=0,rowEnd:n,columns:r,onChunk:i,onComplete:s,rowFormat:f,filter:o,filterStrict:a=!0}=e;if(o&&f!=="object")throw new Error('parquet filter requires rowFormat: "object"');const u=k(o);if(u.length){const p=J(e.metadata).children.map(h=>h.element.name),m=u.filter(h=>!p.includes(h));if(m.length)throw new Error(`parquet filter columns not found: ${m.join(", ")}`)}let c=r,l=!1;if(r&&o){const p=u.filter(m=>!r.includes(m));p.length&&(c=[...r,...p],l=!0)}const d=c!==r?{...e,columns:c}:e,_=Ct(d);if(!s&&!i){for(const{asyncColumns:p}of _)for(const{data:m}of p)await m;return}const w=J(e.metadata),y=_.map(p=>Mt(p,w));if(i)for(const p of y)for(const m of p.asyncColumns)m.data.then(({data:h,pageSkip:g})=>{let A=p.groupStart+g;for(const I of h)i({columnName:m.pathInSchema[0],columnData:I,rowStart:A,rowEnd:A+I.length}),A+=I.length});if(s){const p=[];for(const m of y){const h=Math.max(t-m.groupStart,0),g=Math.min((n??1/0)-m.groupStart,m.groupRows),A=f==="object"?await me(m,h,g,c,"object"):await me(m,h,g,r,"array");if(o){for(const I of A)if(B(I,o,a)){if(l&&r)for(const R of u)r.includes(R)||delete I[R];p.push(I)}}else Oe(p,A)}s(p)}else for(const{asyncColumns:p}of y)for(const{data:m}of p)await m}function Ct(e){if(!e.metadata)throw new Error("parquet requires metadata");const t=ct(e);return e.file=mt(e.file,t),t.groups.map(n=>Pt(e,t,n))}function Ft(e){return e!==null&&typeof e=="object"&&!Array.isArray(e)&&e.format==="parquet_b64"&&typeof e.data=="string"}const M=new Map,qt=8;function de(e,t){if(M.size>=qt){const n=M.keys().next().value;n!==void 0&&M.delete(n)}M.set(e,t)}function $t(e){const t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return n.buffer}function kt(e){const t={};for(const[n,r]of Object.entries(e))if(n==="index"||n==="level_0")t[n]=r;else if(typeof r=="string")try{t[n]=JSON.parse(r)}catch{t[n]=r}else t[n]=r;return t}function Ue(e){if(e==null)return[];if(Array.isArray(e))return e;if(Ft(e)){const t=M.get(e.data);if(t&&t.length>0)return t;try{const n=$t(e.data),r=Z(n);let i=[];return Ut({file:n,metadata:r,rowFormat:"object",onComplete:s=>{i=s.map(kt),de(e.data,i)}}),i.length>0&&de(e.data,i),i}catch(n){return console.error("resolveDFData: failed to decode parquet_b64",n),[]}}return console.warn("resolveDFData: unknown payload format",e),[]}const Yt=(e,t,n,r)=>{if(e==="main")return{data_type:"DataSource",datasource:n,length:r||50};{const i=Ue(t[e]);return{data_type:"Raw",data:i,length:i.length}}};function Ce({df_data_dict:e,df_display_args:t,df_meta:n,operations:r,on_operations:i,operation_results:s,command_config:f,buckaroo_state:o,on_buckaroo_state:a,buckaroo_options:u,src:c}){console.log("132 BuckarooInfiniteWidget");const l=new Date,d=L.useMemo(()=>(console.log("recreating data source because operations changed",l,new Date-l),c.debugCacheState(),Ve(c)),[r,o.post_processing,o.cleaning_method,JSON.stringify(o.quick_command_args)]),[_,w]=L.useState(["a","stoptime"]),y=t[o.df_display],[p,m]=L.useMemo(()=>[Yt(y.data_key,e,d,n.total_rows),Ue(e[y.summary_stats_key])],[y,r,o]),h=[r,o.post_processing,o.quick_command_args,o.df_display];return N.jsxs("div",{className:"dcf-root flex flex-col buckaroo-widget buckaroo-infinite-widget",style:{width:"100%",height:"100%"},children:[N.jsxs("div",{className:"orig-df flex flex-row",style:{overflow:"hidden"},children:[N.jsx(je,{dfMeta:n,buckarooState:o,setBuckarooState:a,buckarooOptions:u}),N.jsx(Ge,{data_wrapper:p,df_viewer_config:y.df_viewer_config,summary_stats_data:m,outside_df_params:h,activeCol:_,setActiveCol:w,error_info:""})]}),o.show_commands?N.jsx(ke,{df_viewer_config:y.df_viewer_config,activeColumn:_,operations:r,setOperations:i,operation_result:s,command_config:f}):N.jsx("span",{})]})}Ce.__docgenInfo={description:"",methods:[],displayName:"BuckarooInfiniteWidget",props:{df_meta:{required:!0,tsType:{name:"DFMeta"},description:""},df_data_dict:{required:!0,tsType:{name:"Record",elements:[{name:"string"},{name:"union",raw:"DFData | ParquetB64Payload",elements:[{name:"Array",elements:[{name:"Record",elements:[{name:"string"},{name:"union",raw:"string | number | boolean | any[] | Record<string, any> | null",elements:[{name:"string"},{name:"number"},{name:"boolean"},{name:"Array",elements:[{name:"any"}],raw:"any[]"},{name:"Record",elements:[{name:"string"},{name:"any"}],raw:"Record<string, any>"},{name:"null"}]}],raw:`Record<
    string,
    string | number | boolean | any[] | Record<string, any> | null
>`}],raw:"DFDataRow[]"},{name:"ParquetB64Payload"}]}],raw:"Record<string, DFDataOrPayload>"},description:""},df_display_args:{required:!0,tsType:{name:"Record",elements:[{name:"string"},{name:"IDisplayArgs"}],raw:"Record<string, IDisplayArgs>"},description:""},operations:{required:!0,tsType:{name:"Array",elements:[{name:"union",raw:"OperationSingleColumn | OperationSingleArg | OperationTwoArg",elements:[{name:"tuple",raw:"[SymbolT, SymbolDf, string]",elements:[{name:"SymbolT"},{name:"SymbolDf"},{name:"string"}]},{name:"tuple",raw:"[SymbolT, SymbolDf, string, Atom]",elements:[{name:"SymbolT"},{name:"SymbolDf"},{name:"string"},{name:"union",raw:"number | string | SymbolT | ColEnumArgs",elements:[{name:"number"},{name:"string"},{name:"SymbolT"},{name:"Record",elements:[{name:"string"},{name:"string"}],raw:"Record<string, string>"}]}]},{name:"tuple",raw:"[SymbolT, SymbolDf, string, Atom, Atom]",elements:[{name:"SymbolT"},{name:"SymbolDf"},{name:"string"},{name:"union",raw:"number | string | SymbolT | ColEnumArgs",elements:[{name:"number"},{name:"string"},{name:"SymbolT"},{name:"Record",elements:[{name:"string"},{name:"string"}],raw:"Record<string, string>"}]},{name:"union",raw:"number | string | SymbolT | ColEnumArgs",elements:[{name:"number"},{name:"string"},{name:"SymbolT"},{name:"Record",elements:[{name:"string"},{name:"string"}],raw:"Record<string, string>"}]}]}]}],raw:"Operation[]"},description:""},on_operations:{required:!0,tsType:{name:"signature",type:"function",raw:"(ops: Operation[]) => void",signature:{arguments:[{type:{name:"Array",elements:[{name:"union",raw:"OperationSingleColumn | OperationSingleArg | OperationTwoArg",elements:[{name:"tuple",raw:"[SymbolT, SymbolDf, string]",elements:[{name:"SymbolT"},{name:"SymbolDf"},{name:"string"}]},{name:"tuple",raw:"[SymbolT, SymbolDf, string, Atom]",elements:[{name:"SymbolT"},{name:"SymbolDf"},{name:"string"},{name:"union",raw:"number | string | SymbolT | ColEnumArgs",elements:[{name:"number"},{name:"string"},{name:"SymbolT"},{name:"Record",elements:[{name:"string"},{name:"string"}],raw:"Record<string, string>"}]}]},{name:"tuple",raw:"[SymbolT, SymbolDf, string, Atom, Atom]",elements:[{name:"SymbolT"},{name:"SymbolDf"},{name:"string"},{name:"union",raw:"number | string | SymbolT | ColEnumArgs",elements:[{name:"number"},{name:"string"},{name:"SymbolT"},{name:"Record",elements:[{name:"string"},{name:"string"}],raw:"Record<string, string>"}]},{name:"union",raw:"number | string | SymbolT | ColEnumArgs",elements:[{name:"number"},{name:"string"},{name:"SymbolT"},{name:"Record",elements:[{name:"string"},{name:"string"}],raw:"Record<string, string>"}]}]}]}],raw:"Operation[]"},name:"ops"}],return:{name:"void"}}},description:""},operation_results:{required:!0,tsType:{name:"signature",type:"object",raw:`{
    transformed_df: DFWhole;
    generated_py_code: string;
    transform_error?: string;
}`,signature:{properties:[{key:"transformed_df",value:{name:"DFWhole",required:!0}},{key:"generated_py_code",value:{name:"string",required:!0}},{key:"transform_error",value:{name:"string",required:!1}}]}},description:""},command_config:{required:!0,tsType:{name:"signature",type:"object",raw:`{
    argspecs: CommandArgSpec;
    defaultArgs: OperationDefaultArgs;
}`,signature:{properties:[{key:"argspecs",value:{name:"Record",elements:[{name:"string"},{name:"Array",elements:[{name:"union",raw:"TypeSpec | EnumSpec | ColEnumSpec | NoArgs",elements:[{name:"tuple",raw:'[number, string, "type", "integer" | "float" | "string"]',elements:[{name:"number"},{name:"string"},{name:"literal",value:'"type"'},{name:"union",raw:'"integer" | "float" | "string"',elements:[{name:"literal",value:'"integer"'},{name:"literal",value:'"float"'},{name:"literal",value:'"string"'}]}]},{name:"tuple",raw:'[number, string, "enum", string[]]',elements:[{name:"number"},{name:"string"},{name:"literal",value:'"enum"'},{name:"Array",elements:[{name:"string"}],raw:"string[]"}]},{name:"tuple",raw:'[number, string, "colEnum", string[]]',elements:[{name:"number"},{name:"string"},{name:"literal",value:'"colEnum"'},{name:"Array",elements:[{name:"string"}],raw:"string[]"}]},{name:"null"}]}],raw:"ArgSpec[]"}],raw:"Record<string, ArgSpec[]>",required:!0}},{key:"defaultArgs",value:{name:"Record",elements:[{name:"string"},{name:"union",raw:"OperationSingleColumn | OperationSingleArg | OperationTwoArg",elements:[{name:"tuple",raw:"[SymbolT, SymbolDf, string]",elements:[{name:"SymbolT"},{name:"SymbolDf"},{name:"string"}]},{name:"tuple",raw:"[SymbolT, SymbolDf, string, Atom]",elements:[{name:"SymbolT"},{name:"SymbolDf"},{name:"string"},{name:"union",raw:"number | string | SymbolT | ColEnumArgs",elements:[{name:"number"},{name:"string"},{name:"SymbolT"},{name:"Record",elements:[{name:"string"},{name:"string"}],raw:"Record<string, string>"}]}]},{name:"tuple",raw:"[SymbolT, SymbolDf, string, Atom, Atom]",elements:[{name:"SymbolT"},{name:"SymbolDf"},{name:"string"},{name:"union",raw:"number | string | SymbolT | ColEnumArgs",elements:[{name:"number"},{name:"string"},{name:"SymbolT"},{name:"Record",elements:[{name:"string"},{name:"string"}],raw:"Record<string, string>"}]},{name:"union",raw:"number | string | SymbolT | ColEnumArgs",elements:[{name:"number"},{name:"string"},{name:"SymbolT"},{name:"Record",elements:[{name:"string"},{name:"string"}],raw:"Record<string, string>"}]}]}]}],raw:"Record<string, Operation>",required:!0}}]}},description:""},buckaroo_state:{required:!0,tsType:{name:"BuckarooState"},description:""},on_buckaroo_state:{required:!0,tsType:{name:"ReactDispatch",raw:"React.Dispatch<React.SetStateAction<BuckarooState>>",elements:[{name:"ReactSetStateAction",raw:"React.SetStateAction<BuckarooState>",elements:[{name:"BuckarooState"}]}]},description:""},buckaroo_options:{required:!0,tsType:{name:"BuckarooOptions"},description:""},src:{required:!0,tsType:{name:"KeyAwareSmartRowCache"},description:""}}};const jt=["Alice","Bob","Charlie","Diana","Eve"],G=5,_e=jt.map((e,t)=>({index:t,name:e,age:25+t*3,score:80+t*3.5})),Fe=[{index:"dtype",name:"object",age:"int64",score:"float64"},{index:"count",name:5,age:5,score:5},{index:"unique",name:5,age:5,score:5},{index:"mean",name:"N/A",age:34,score:90.5},{index:"min",name:"Alice",age:25,score:80},{index:"max",name:"Eve",age:37,score:94}],Vt=Fe.map(e=>({primary_key_val:e.index,displayer_args:{displayer:"obj"}})),qe={column_config:[{col_name:"name",header_name:"name",displayer_args:{displayer:"obj"}},{col_name:"age",header_name:"age",displayer_args:{displayer:"integer",min_digits:1,max_digits:5}},{col_name:"score",header_name:"score",displayer_args:{displayer:"float",min_fraction_digits:1,max_fraction_digits:2}}],pinned_rows:[],left_col_configs:[{col_name:"index",header_name:"index",displayer_args:{displayer:"string"}}]},Gt={...qe,pinned_rows:Vt},zt={main:{data_key:"main",df_viewer_config:qe,summary_stats_key:"all_stats"},summary:{data_key:"main",df_viewer_config:Gt,summary_stats_key:"all_stats"}},Wt={total_rows:G,columns:3,filtered_rows:G,rows_shown:G},Kt={sampled:[],cleaning_method:[],post_processing:[],df_display:["main","summary"],show_commands:[]},Ht={argspecs:{},defaultArgs:{}},Zt=()=>{const[e,t]=L.useState({sampled:!1,cleaning_method:!1,quick_command_args:{},post_processing:!1,df_display:"main",show_commands:!1}),[n,r]=L.useState([]),i=L.useMemo(()=>{const f=new ze(o=>{let a=_e;try{const l=JSON.parse(o.sourceName||"[]"),d=l[2]||l[1];if(d&&typeof d=="object"&&d.search&&d.search[0]){const _=String(d.search[0]).toLowerCase();a=_e.filter(w=>String(w.name).toLowerCase().includes(_))}}catch{}const u=Math.min(o.end,a.length);if(u<=o.start){const l={key:o,data:[],length:a.length};setTimeout(()=>f.addPayloadResponse(l),10);return}const c={key:o,data:a.slice(o.start,u),length:a.length};setTimeout(()=>f.addPayloadResponse(c),10)});return f},[]),s=L.useMemo(()=>({main:[],all_stats:Fe,empty:[]}),[]);return N.jsx("div",{style:{height:600,width:900},children:N.jsx(Ce,{df_meta:Wt,df_data_dict:s,df_display_args:zt,operations:n,on_operations:r,operation_results:Ye,command_config:Ht,buckaroo_state:e,on_buckaroo_state:t,buckaroo_options:Kt,src:i})})},wn={title:"Buckaroo/BuckarooWidgetTest",component:Zt,parameters:{layout:"centered"}},q={};var ge,pe,we;q.parameters={...q.parameters,docs:{...(ge=q.parameters)==null?void 0:ge.docs,source:{originalSource:"{}",...(we=(pe=q.parameters)==null?void 0:pe.docs)==null?void 0:we.source}}};const yn=["Primary"];export{q as Primary,yn as __namedExportsOrder,wn as default};
